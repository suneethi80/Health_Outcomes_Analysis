---
title: "midstone_sunee"
author: "Suneethi"
date: "1/2/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:
#Libraries
```{r cars}
library(tidyverse)
library(readxl)
install.packages(c("maps", "mapdata"))
library(maps)
library(forcats)
library(ggplot2)
library(plotly)
library(viridis)
library(GGally)


```

Read the csv file- tn 2019 county health rankings
```{r}
tn_2019<-read_excel('data/2019 County Health Rankings Tennessee Data - v1_0.xls', 4, skip=1)
```

take a glimpse and remove unncessary columns

```{r}
glimpse(tn_2019)
```
#select specific columns from tn_2019_msrs
```{r}

tn_2019_msrs<-tn_2019 %>% 
  select(FIPS, State, County, `Years of Potential Life Lost Rate`, `YPLL Rate (Black)`, `YPLL Rate (Hispanic)`, `YPLL Rate (White)`, `% Fair/Poor`, `Physically Unhealthy Days`, `Mentally Unhealthy Days`, `% LBW`, `% LBW (Black)`, `% LBW (Hispanic)`, `% LBW (White)`, `% Smokers`, `% Obese`, `Food Environment Index`, `% Physically Inactive`, `% With Access`, `% Excessive Drinking`, `# Alcohol-Impaired Driving Deaths`, `# Driving Deaths`, `% Alcohol-Impaired`, `# Chlamydia Cases`, `Chlamydia Rate`, `Teen Birth Rate`, `Teen Birth Rate (Black)`, `Teen Birth Rate (Hispanic)`, `Teen Birth Rate (White)`, `# Uninsured`, `% Uninsured`, `# Primary Care Physicians`, `PCP Rate`, `PCP Ratio`, `# Dentists`, `Dentist Rate`, `Dentist Ratio`, `# Mental Health Providers`, `MHP Rate`, `MHP Ratio`, `Preventable Hosp. Rate`, `Preventable Hosp. Rate (Black)`, `Preventable Hosp. Rate (Hispanic)`, `Preventable Hosp. Rate (White)`, `% Screened`, `% Screened (Black)`, `% Screened (Hispanic)`, `% Screened (White)`, `% Vaccinated`, `% Vaccinated (Black)`, `% Vaccinated (Hispanic)`, `% Vaccinated (White)`, `Cohort Size`, `Graduation Rate`, `# Some College`, Population, `% Some College`, `# Unemployed`, `Labor Force`, `% Unemployed`, `% Children in Poverty`, `% Children in Poverty (Black)`, `% Children in Poverty (Hispanic)`, `% Children in Poverty (White)`, `80th Percentile Income`, `20th Percentile Income`, `Income Ratio`, `# Single-Parent Households`, `# Households`, `% Single-Parent Households`, `# Associations`, `Association Rate`, `Annual Average Violent Crimes`, `Violent Crime Rate`, `# Injury Deaths`, `Injury Death Rate`, `Average Daily PM2.5`, `Presence of violation`, `% Severe Housing Problems`, `Severe Housing Cost Burden`, Overcrowding, `Inadequate Facilities`, `% Drive Alone`, `% Drive Alone (Black)`, `% Drive Alone (Hispanic)`, `% Drive Alone (White)`, `# Workers who Drive Alone`, `% Long Commute - Drives Alone`)
```


Rename some columns in tn_2019msrs
```{r}
tn_2019_msrs<-tn_2019_msrs %>% 
  rename(pct_fair_poor_health = `% Fair/Poor`, pct_exercise_access =`% With Access`, pct_mammography_screen =`% Screened`, pct_mammo_screend_blk = `% Screened (Black)`, pct_mammo_screend_hisp = `% Screened (Hispanic)`, pct_mammo_screend_white = `% Screened (White)`, pct_flu_vaccintd = `% Vaccinated`, pct_flu_vaccintd_blk = `% Vaccinated (Black)`, pct_flu_vaccintd_hisp = `% Vaccinated (Hispanic)`, pct_flu_vaccintd_white = `% Vaccinated (White)`, cohort_grad_size = `Cohort Size`, college_25to44age = `# Some College`)
```

#remove FIPS=47000 - whole state of tennessee observations
```{r}
tn_2019_msrs1<-tn_2019_msrs %>% 
  filter(FIPS!=47000)
```


Plots:
1) Counties with lowest birth weight?
2)correlation between teen births and low birth weight
3)distribution of uninsured population
4)county with highest or lowest uninsured population
5)correlation between income and uninsured?
6) use additional health measures data for demographics data and for uninsured adults vs children

low birth weight distribution:
```{r}
tn_2019_msrs %>% 
  ggplot(aes(x=`% LBW`)) +
  geom_histogram(bins=10, fill="skyblue")
```
most of low birth weight between 8-10
Counties with lowest birth weight:
```{r}
tn_2019_msrs %>% 
  arrange(`% LBW`) %>% 
  top_n(5, `% LBW`) %>% 
  ggplot(aes(x=County, y=`% LBW`)) +
  geom_col()
```


#read in the additional measure sheet that has demographics data
```{r}
tn_2019_addn<-read_excel('data/2019 County Health Rankings Tennessee Data - v1_0.xls', 5, skip=1)
```

# Glimpse of additional measures dataset and select specific columns

```{r}
tn_2019_addn<-tn_2019_addn %>% 
   select(FIPS, State, County, `Life Expectancy`, `Life Expectancy (Black)`, `Life Expectancy (Hispanic)`, `Life Expectancy (White)`, `# Deaths...10`, `Age-Adjusted Mortality`, `Age-Adjusted Mortality (Black)`, `Age-Adjusted Mortality (Hispanic)`, `Age-Adjusted Mortality (White)`, `# Deaths...17`, `Child Mortality Rate`, `Child Mortality Rate (Black)`, `Child Mortality Rate (Hispanic)`, `Child Mortality Rate (White)`, `# Deaths...24`, `Infant Mortality Rate`, `Infant Mortality Rate (Black)`, `Infant Mortality Rate (Hispanic)`, `Infant Mortality Rate (White)`, `% Frequent Physical Distress`, `% Frequent Mental Distress`, `% Diabetic`, `# HIV Cases`, `HIV Prevalence Rate`, `# Food Insecure`, `% Food Insecure`, `# Limited Access`, `% Limited Access`, `# Drug Overdose Deaths`, `Drug Overdose Mortality Rate`, `# Motor Vehicle Deaths`, `MV Mortality Rate`, `% Insufficient Sleep`, `# Uninsured...55`, `% Uninsured...56`, `# Uninsured...59`, `% Uninsured...60`, `Other PCP Rate`, `Other PCP Ratio`, `% Disconnected Youth`, `Household Income`, `Household income (Black)`, `Household income (Hispanic)`, `Household income (White)`, `Segregation index`, `Segregation Index`, `Homicide Rate`, `# Firearm Fatalities`, `Firearm Fatalities Rate`, `# Homeowners`, `% Homeowners`, `# Households with Severe Cost Burden`, Population, `% Severe Housing Cost Burden`, Population, `% < 18`, `% 65 and over`, `# African American`, `% African American`, `# American Indian/Alaskan Native`, `% American Indian/Alaskan Native`, `# Asian`, `% Asian`, `# Native Hawaiian/Other Pacific Islander`, `% Native Hawaiian/Other Pacific Islander`, `# Hispanic`, `% Hispanic`, `# Non-Hispanic White`, `% Non-Hispanic White`, `# Not Proficient in English`, `% Not Proficient in English`, `% Female`, `# Rural`, `% Rural`)
```


#removing tennessee row from tn_2019_addn
```{r}
tn_2019_addnl<-tn_2019_addn %>% 
  filter(FIPS!=47000)
```

```{r}
glimpse(tn_2019_addn)
```

plotting demographics
```{r}
tn_2019_addn %>%
   filter(FIPS!=47000) %>% 
   ggplot(aes(x=Population)) + geom_histogram(bins=20) 
```

demographics only dataset taken from orginal addtal measures data
included in demographics - population, population based on age, race and sex and rural, homeowners, household income
```{r}
demo_tn_2019<- tn_2019_addnl %>% 
  select(FIPS, State, County, `Household Income`, `Household income (Black)`, `Household income (Hispanic)`, `Household income (White)`, `Segregation index`, `Segregation Index`, `# Homeowners`, `% Homeowners`, `# Households with Severe Cost Burden`, Population, `% Severe Housing Cost Burden`, Population, `% < 18`, `% 65 and over`, `# African American`, `% African American`, `# American Indian/Alaskan Native`, `% American Indian/Alaskan Native`, `# Asian`, `% Asian`, `# Native Hawaiian/Other Pacific Islander`, `% Native Hawaiian/Other Pacific Islander`, `# Hispanic`, `% Hispanic`, `# Non-Hispanic White`, `% Non-Hispanic White`, `# Not Proficient in English`, `% Not Proficient in English`, `% Female`, `# Rural`, `% Rural`)
```

```{r}
demo_tn_2019 %>% 
  arrange(`Household Income`) %>% 
  mutate(County= fct_reorder(County, `Household Income`)) %>% 
  top_n(10, `Household Income`) %>% 
  ggplot(aes(x=County, y=`Household Income`)) +
  geom_point(color="blue", size=4, alpha=0.6) +
  geom_segment(aes(x=County, xend=County, y=0, yend=`Household Income`), color="skyblue")+
  labs(title="Top 10 Counties with Highest Income")+
  theme_light() +
  coord_flip() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank(),
    text = element_text(size=15)
  )
```

```{r}
demo_tn_2019 %>% 
  arrange(`Household Income`) %>% 
  mutate(County= fct_reorder(County, `Household Income`)) %>% 
  top_n(-10, `Household Income`) %>% 
  ggplot(aes(x=County, y=`Household Income`)) +
  geom_point(color="blue", size=4, alpha=0.6) +
  geom_segment(aes(x=County, xend=County, y=0, yend=`Household Income`), color="skyblue")+
  theme_light() +
  coord_flip() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank(),
    text = element_text(size=15)
  )
```

#tn map showing population 

```{r}
states <- map_data("state")
tn<-subset(states, region %in% c("tennessee"))
ggplot(data = tn) + 
  geom_polygon(aes(x = long, y = lat), fill = "palegreen", color = "black") +
  coord_fixed(1.3)
tn_df<-subset(states, region=="tennessee")
counties<-map_data("county")
tn_county<-subset(counties, region=="tennessee")
tn_base <- ggplot(data = tn_df, mapping = aes(x = long, y = lat, group = group)) + 
  coord_fixed(1.3) + 
  geom_polygon(color = "black", fill = "gray")
tn_base +  
  geom_polygon(data = tn_county, fill = NA, color = "white") +
  geom_polygon(color = "black", fill = NA)  

  
```

```{r}
head(tn_county)
tn_county<-tn_county %>% 
  rename(County=subregion, State=region)
head(tn_county)
```


```{r}
demo_tn_pops<-demo_tn_2019 %>% 
  select(State, County, Population, `% Rural`) %>% 
  rename(Rural_pct=`% Rural`)
demo_tn_pops$County<-tolower(demo_tn_pops$County)
head(demo_tn_pops)
names(demo_tn_pops)<-c("State", "County", "Population", "Rural_pct")
demo_tn_pops$Population <- as.numeric(demo_tn_pops$Population)
head(demo_tn_pops)

```

```{r}
ditch_the_axes <- theme(
  axis.text = element_blank(),
  axis.line = element_blank(),
  axis.ticks = element_blank(),
  panel.border = element_blank(),
  panel.grid = element_blank(),
  axis.title = element_blank())
tncopa <- inner_join(tn_county, demo_tn_pops, by = "County")
saveRDS(tncopa, file="tncopa.RDS")
saveRDS(demo_tn_pops, file="demo_tn_pops.RDS")
elb<-tn_base + 
      geom_polygon(data = tncopa, aes(fill = Population), color = "white") +
      geom_polygon(color = "black", fill = NA) +
    theme_bw() +
      ditch_the_axes 
elb
elb<-elb + 
    scale_fill_gradientn(colours = rev(rainbow(7)),
                         breaks = c(10000, 30000, 100000, 300000, 700000),
                         trans = "log10")
elb
ggplotly(elb)

```

```{r}
elb1<-tn_base + 
      geom_polygon(data = tncopa, aes(fill = Rural_pct), color = "white") +
      geom_polygon(color = "black", fill = NA) +
    theme_bw() +
      ditch_the_axes +  
  ggtitle("Percentage of Rural Population in Tennessee Counties") +
    scale_fill_gradientn(colours = rev(rainbow(7)),
                         trans = "log10")


ggplotly(elb1)

```

# Full join or inner join of tn_2019_msrs1 and tn_2019_addnl
```{r}
tn_2019_healthtotal<-full_join(tn_2019_msrs1, tn_2019_addnl, by="County")
tn_2019_healthtotal<-tn_2019_healthtotal %>% 
  rename(Premature_deaths= `# Deaths...10`, child_mortality =`# Deaths...17`, infant_mortality=`# Deaths...24`)
```

#Save complete dataset as RDS
```{r}
saveRDS(tn_2019_healthtotal, file = "tn_2019_totalhealth.RDS")
```

#Health factors alone dataset: %diabetic, hiv cases, physical/mental unhealthy days, %smokers, %obese, %excessive drinking and #chlamydia cases
```{r}
tn_2019_hfactors<-tn_2019_healthtotal %>% 
  select(FIPS.x, State.x, County, `% Diabetic`, `# HIV Cases`, `HIV Prevalence Rate`, `Physically Unhealthy Days`, `Mentally Unhealthy Days`, `% Smokers`, `% Obese`, `% Excessive Drinking`, `# Chlamydia Cases`, `Chlamydia Rate`)
tn_2019_hfactors<-tn_2019_hfactors %>% 
  rename(FIPS=FIPS.x, State=State.x)
tn_2019_hfactors1<-tn_2019_hfactors %>% 
  select(County, `% Diabetic`, `% Smokers`, `% Obese`, `% Excessive Drinking`)



```

#pivot the data for tn_2019_hfactors
```{r}
tn_2019_hlth<-tn_2019_hfactors1 %>% 
  rename(Diabetic=`% Diabetic`, Smokers=`% Smokers`, Obese=`% Obese`, `Excess Drinking`=`% Excessive Drinking`) %>% 
  pivot_longer(cols=c(Diabetic, Smokers, Obese, `Excess Drinking`), names_to = "outcome", values_to = "value")
tn_2019_hlth
```

```{r}
saveRDS(tn_2019_hlth, file="tn_2019hfactors.RDS")
```

```{r}
class(tn_2019_hlth)
#p<-as.data.frame(p)
```

#Plots to show county wise health measures like %diabetic and % obese
types of plots - facet?
```{r}
tn_2019_hlth %>% 
  ggplot(aes(x=County, y=value, fill=outcome)) + 
  geom_bar(position="dodge", stat="identity") +
  facet_wrap(~outcome) 
  
```


```{r}
tn_2019_hlth %>% 
  filter(County=="Davidson") %>% 
  ggplot(aes(x=County, y=value, fill=outcome)) + 
  geom_bar(position="dodge", stat="identity") 
```

```{r}
tn_2019_hlth %>% 
  filter(County=="Anderson") %>% 
  ggplot(aes(x=County, y=value)) + 
                geom_bar(position="dodge", stat="identity") +
                facet_wrap(~outcome)

```

```{r}
tn_2019_hlth %>% 
  filter(County=="Anderson") %>% 
  ggplot(aes(x=outcome, y=value)) + 
                geom_bar(position="dodge", stat="identity") 
```

# Mortality pivoted data
```{r}
mortality<-tn_2019_healthtotal %>% 
  select(County, `# Alcohol-Impaired Driving Deaths`, `# Driving Deaths`, `Age-Adjusted Mortality`, `Child Mortality Rate`, `Infant Mortality Rate`, `Drug Overdose Mortality Rate`, `MV Mortality Rate`, `Homicide Rate`, `Firearm Fatalities Rate`)
  
mortality<-mortality %>% 
  rename(`Alcohol-Impaired` = `# Alcohol-Impaired Driving Deaths`, Driving=`# Driving Deaths`, `Drug Overdose`=`Drug Overdose Mortality Rate`, `Motor Vehicle`=`MV Mortality Rate`, Homicide= `Homicide Rate`, Firearm = `Firearm Fatalities Rate`) %>% 
  pivot_longer(cols=c(`Alcohol-Impaired`, Driving, `Age-Adjusted Mortality`, `Child Mortality Rate`, `Infant Mortality Rate`, `Drug Overdose`, `Motor Vehicle`, `Homicide`, `Firearm`), names_to = "Deaths", values_to = "value")

head(mortality)


```

#Save RDS for mortality
```{r}
saveRDS(mortality, file="mortality.RDS")
```

#plot mortality for a specific county
```{r}
mortality %>% 
  filter(County=="Anderson") %>% 
  ggplot(aes(x=Deaths, y=value)) + 
                geom_bar(position="dodge", stat="identity") +
  coord_flip()
```
#Rename Population in healthtotal
```{r}
tn_2019_healthtotal<-tn_2019_healthtotal %>% 
  rename(Pop_25to44=Population.x, Pop_total=Population.y)
tn_2019_healthtotal<-tn_2019_healthtotal %>% 
  rename(Rural_pct=`% Rural`)
tn_2019_healthtotal<-tn_2019_healthtotal %>% 
  rename(Diabetic_pct=`% Diabetic`, Smokers_pct=`% Smokers`)
tn_2019_healthtotal<-tn_2019_healthtotal %>% 
  rename(Obese_pct= `% Obese`, Excess_drinkg_pct=`% Excessive Drinking`, Alcohol_drivg_death= `# Alcohol-Impaired Driving Deaths`, alcohol_impaird=`% Alcohol-Impaired`, Drivg_deaths_no=`# Driving Deaths`, Uninsured_pct=`% Uninsured`, College_pct=`% Some College`, Unemployed_pct=`% Unemployed`, Childrn_poverty_pct=`% Children in Poverty`, singl_parent_househld_pct=`% Single-Parent Households`, Injury_death_no=`# Injury Deaths`, Housing_prblm_pct=`% Severe Housing Problems`, Lack_sleep=`% Insufficient Sleep`, Uninsurd_adults_pct=`% Uninsured...56`, Uninsurd_childrn_pct=`% Uninsured...60`, Homeownr_pct=`% Homeowners`)
tn_2019_healthtotal<-tn_2019_healthtotal %>% 
  rename(lbw_pct=`% LBW`)
tn_2019_healthtotal<-tn_2019_healthtotal %>% 
  rename(alcohol_impaird_pct=alcohol_impaird)
         
         
```

```{r}
class(tn_2019_healthtotal)
```
#Counties with highest and lowest rural population
```{r}
tn_2019_healthtotal %>% 
  arrange(desc(Rural_pct)) %>% 
  top_n(n=10, wt=Rural_pct) %>% 
  mutate(County= fct_reorder(County, Rural_pct)) %>% 
  ggplot(aes(x=County, y=Rural_pct)) +
  geom_point(color="blue", size=4, alpha=0.6) +
  geom_segment(aes(x=County, xend=County, y=0, yend=Rural_pct), color="skyblue")+
  labs(title="Counties with Highest Rural Population")+
  xlab("Counties") +
  ylab("Rural Population Percentage") +
  theme_light() +
  coord_flip() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank(),
    text = element_text(size=15)
  )
  
```

Health disorders in counties with highest rural population
```{r}
tn_2019_healthtotal %>% 
  filter(Rural_pct==100) %>% 
  slice(1:6) %>% 
  #gather(key="MesureType", value="Val") %>% 
  ggplot(aes(x=County, y=Smokers_pct, fill=County))+
  geom_bar(stat="identity")+
  coord_flip()+
  theme_classic()
```

#Pivot the data with rural % and health disorders


#Pivot the data with rural % and socio-economic factors


#pivot the data with rural % and mortality rates




#Effect of Rural population on health status, college education and teen births
```{r}
r<-tn_2019_healthtotal %>% 
  ggplot(aes(x=Rural_pct, y=College_pct)) +
  geom_point(color="black") +
  theme_classic()
ggplotly(r)
```

```{r}
tn_2019_healthtotal %>% 
  ggplot(aes(x=Rural_pct, y=Smokers_pct)) +
  geom_point(color="black") +
  theme_classic()
```

#distribution of obesity
```{r}
a<-tn_2019_healthtotal %>% 
  ggplot(aes(x=Obese_pct))+
  geom_histogram() +theme_classic()
ggplotly(a)
```


```{r}
tn_2019_healthtotal %>% 
  select(`Rural_pct`, Excess_drinkg_pct, alcohol_impaird_pct, Smokers_pct, Diabetic_pct, `Teen Birth Rate`, `Uninsured_pct`, `PCP Rate`, `College_pct`, Unemployed_pct, `Childrn_poverty_pct`, `Violent Crime Rate`, `Child Mortality Rate`, `Infant Mortality Rate`) %>% 
  ggcorr(nbreaks=5, hjust=0.75, size = 3, color = "grey50", label=TRUE, layout.exp=1, label_alpha=TRUE)
```

For shinyapp:
compare between states using data reported within the same years. 
Note- Years reported are not the same as data reported in same year,
example- 2019 tn report does not mean infant mortality is reported for 2019. its a span of years or not a span. 
it is possible to compare between years but it wont be year by year comparison ust 
## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
usa <- map_data("usa") # we already did this, but we can do it again
ggplot() + geom_polygon(data = usa, aes(x=long, y = lat, group = group)) + 
  coord_fixed(1.3)
```

```{r}
states <- map_data("state")
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.

#Saving as RDS file as input for shinyapps
```{r}
saveRDS(tn_2019_msrs, file = "tn_2019.RDS")
```

#Glimpse of tn-2019_healthtotal
```{r}
glimpse(tn_2019_healthtotal)
```

